# Aderyn Analysis Report

This report was generated by [Aderyn](https://github.com/Cyfrin/aderyn), a static analysis tool built by [Cyfrin](https://cyfrin.io), a blockchain security company. This report is not a substitute for manual audit or security review. It should not be relied upon for any purpose other than to assist in the identification of potential security vulnerabilities.
# Table of Contents

- [Summary](#summary)
  - [Files Summary](#files-summary)
  - [Files Details](#files-details)
  - [Issue Summary](#issue-summary)
- [High Issues](#high-issues)
  - [H-1: Reentrancy: State change after external call](#h-1-reentrancy-state-change-after-external-call)
- [Low Issues](#low-issues)
  - [L-1: Centralization Risk](#l-1-centralization-risk)
  - [L-2: Large Numeric Literal](#l-2-large-numeric-literal)
  - [L-3: Literal Instead of Constant](#l-3-literal-instead-of-constant)
  - [L-4: `nonReentrant` is Not the First Modifier](#l-4-nonreentrant-is-not-the-first-modifier)
  - [L-5: State Change Without Event](#l-5-state-change-without-event)
  - [L-6: Address State Variable Set Without Checks](#l-6-address-state-variable-set-without-checks)
  - [L-7: Unchecked Return](#l-7-unchecked-return)
  - [L-8: Unused Error](#l-8-unused-error)


# Summary

## Files Summary

| Key | Value |
| --- | --- |
| .sol Files | 5 |
| Total nSLOC | 535 |


## Files Details

| Filepath | nSLOC |
| --- | --- |
| src/staking/RewardsDistributor.sol | 151 |
| src/staking/Staking.sol | 160 |
| src/token/K613.sol | 53 |
| src/token/xK613.sol | 81 |
| src/treasury/Treasury.sol | 90 |
| **Total** | **535** |


## Issue Summary

| Category | No. of Issues |
| --- | --- |
| High | 1 |
| Low | 8 |


# High Issues

## H-1: Reentrancy: State change after external call

Changing state after an external call can lead to re-entrancy attacks.Use the checks-effects-interactions pattern to avoid this issue.

<details><summary>8 Found Instances</summary>


- Found in src/staking/Staking.sol [Line: 159](src/staking/Staking.sol#L159)

	State is changed at: `s.amount -= amount`
	```solidity
	        rewardsDistributor.removeExitPending(msg.sender, amount);
	```

- Found in src/staking/Staking.sol [Line: 160](src/staking/Staking.sol#L160)

	State is changed at: `s.amount -= amount`
	```solidity
	        rewardsDistributor.withdrawFor(msg.sender, amount);
	```

- Found in src/staking/Staking.sol [Line: 162](src/staking/Staking.sol#L162)

	State is changed at: `s.amount -= amount`
	```solidity
	        xk613.burnFrom(address(this), amount);
	```

- Found in src/staking/Staking.sol [Line: 184](src/staking/Staking.sol#L184)

	State is changed at: `s.amount -= amount`
	```solidity
	        rewardsDistributor.removeExitPending(msg.sender, amount);
	```

- Found in src/staking/Staking.sol [Line: 185](src/staking/Staking.sol#L185)

	State is changed at: `s.amount -= amount`
	```solidity
	        rewardsDistributor.withdrawFor(msg.sender, amount);
	```

- Found in src/staking/Staking.sol [Line: 187](src/staking/Staking.sol#L187)

	State is changed at: `s.amount -= amount`
	```solidity
	        xk613.burnFrom(address(this), amount);
	```

- Found in src/staking/Staking.sol [Line: 190](src/staking/Staking.sol#L190)

	State is changed at: `s.amount -= amount`
	```solidity
	            xk613.mint(address(rewardsDistributor), penalty);
	```

- Found in src/staking/Staking.sol [Line: 191](src/staking/Staking.sol#L191)

	State is changed at: `s.amount -= amount`
	```solidity
	            rewardsDistributor.notifyReward(penalty);
	```

</details>



# Low Issues

## L-1: Centralization Risk

Contracts have owners with privileged rights to perform admin tasks and need to be trusted to not perform malicious updates or drain funds.

<details><summary>29 Found Instances</summary>


- Found in src/staking/RewardsDistributor.sol [Line: 13](src/staking/RewardsDistributor.sol#L13)

	```solidity
	contract RewardsDistributor is AccessControl, Pausable, ReentrancyGuard {
	```

- Found in src/staking/RewardsDistributor.sol [Line: 58](src/staking/RewardsDistributor.sol#L58)

	```solidity
	    function setStaking(address staking_) external onlyRole(DEFAULT_ADMIN_ROLE) {
	```

- Found in src/staking/RewardsDistributor.sol [Line: 73](src/staking/RewardsDistributor.sol#L73)

	```solidity
	    function depositFor(address user, uint256 amount) external onlyRole(STAKING_ROLE) whenNotPaused {
	```

- Found in src/staking/RewardsDistributor.sol [Line: 83](src/staking/RewardsDistributor.sol#L83)

	```solidity
	    function addExitPending(address user, uint256 amount) external onlyRole(STAKING_ROLE) whenNotPaused {
	```

- Found in src/staking/RewardsDistributor.sol [Line: 93](src/staking/RewardsDistributor.sol#L93)

	```solidity
	    function removeExitPending(address user, uint256 amount) external onlyRole(STAKING_ROLE) whenNotPaused {
	```

- Found in src/staking/RewardsDistributor.sol [Line: 103](src/staking/RewardsDistributor.sol#L103)

	```solidity
	    function withdrawFor(address user, uint256 amount) external onlyRole(STAKING_ROLE) whenNotPaused {
	```

- Found in src/staking/RewardsDistributor.sol [Line: 128](src/staking/RewardsDistributor.sol#L128)

	```solidity
	    function notifyReward(uint256 amount) external nonReentrant onlyRole(REWARDS_NOTIFIER_ROLE) whenNotPaused {
	```

- Found in src/staking/RewardsDistributor.sol [Line: 139](src/staking/RewardsDistributor.sol#L139)

	```solidity
	    function pause() external onlyRole(PAUSER_ROLE) {
	```

- Found in src/staking/RewardsDistributor.sol [Line: 143](src/staking/RewardsDistributor.sol#L143)

	```solidity
	    function unpause() external onlyRole(PAUSER_ROLE) {
	```

- Found in src/staking/Staking.sol [Line: 15](src/staking/Staking.sol#L15)

	```solidity
	contract Staking is AccessControl, Pausable, ReentrancyGuard {
	```

- Found in src/staking/Staking.sol [Line: 73](src/staking/Staking.sol#L73)

	```solidity
	    function setRewardsDistributor(address distributor) external onlyRole(DEFAULT_ADMIN_ROLE) {
	```

- Found in src/staking/Staking.sol [Line: 208](src/staking/Staking.sol#L208)

	```solidity
	    function pause() external onlyRole(PAUSER_ROLE) {
	```

- Found in src/staking/Staking.sol [Line: 212](src/staking/Staking.sol#L212)

	```solidity
	    function unpause() external onlyRole(PAUSER_ROLE) {
	```

- Found in src/token/K613.sol [Line: 11](src/token/K613.sol#L11)

	```solidity
	contract K613 is ERC20, AccessControl, Pausable {
	```

- Found in src/token/K613.sol [Line: 43](src/token/K613.sol#L43)

	```solidity
	    function setMinter(address newMinter) external onlyRole(DEFAULT_ADMIN_ROLE) {
	```

- Found in src/token/K613.sol [Line: 74](src/token/K613.sol#L74)

	```solidity
	    function pause() external onlyRole(PAUSER_ROLE) {
	```

- Found in src/token/K613.sol [Line: 79](src/token/K613.sol#L79)

	```solidity
	    function unpause() external onlyRole(PAUSER_ROLE) {
	```

- Found in src/token/xK613.sol [Line: 15](src/token/xK613.sol#L15)

	```solidity
	contract xK613 is ERC20, AccessControl, Pausable {
	```

- Found in src/token/xK613.sol [Line: 57](src/token/xK613.sol#L57)

	```solidity
	    function setMinter(address newMinter) external onlyRole(DEFAULT_ADMIN_ROLE) {
	```

- Found in src/token/xK613.sol [Line: 69](src/token/xK613.sol#L69)

	```solidity
	    function setRewardsDistributor(address distributor_) external onlyRole(DEFAULT_ADMIN_ROLE) {
	```

- Found in src/token/xK613.sol [Line: 76](src/token/xK613.sol#L76)

	```solidity
	    function setTransferWhitelist(address account, bool allowed) external onlyRole(DEFAULT_ADMIN_ROLE) {
	```

- Found in src/token/xK613.sol [Line: 102](src/token/xK613.sol#L102)

	```solidity
	    function pause() external onlyRole(PAUSER_ROLE) {
	```

- Found in src/token/xK613.sol [Line: 107](src/token/xK613.sol#L107)

	```solidity
	    function unpause() external onlyRole(PAUSER_ROLE) {
	```

- Found in src/treasury/Treasury.sol [Line: 16](src/treasury/Treasury.sol#L16)

	```solidity
	contract Treasury is AccessControl, Pausable, ReentrancyGuard {
	```

- Found in src/treasury/Treasury.sol [Line: 71](src/treasury/Treasury.sol#L71)

	```solidity
	    function depositRewards(uint256 amount) external nonReentrant onlyRole(DEFAULT_ADMIN_ROLE) whenNotPaused {
	```

- Found in src/treasury/Treasury.sol [Line: 95](src/treasury/Treasury.sol#L95)

	```solidity
	    ) external onlyRole(DEFAULT_ADMIN_ROLE) nonReentrant whenNotPaused returns (uint256 k613Out) {
	```

- Found in src/treasury/Treasury.sol [Line: 124](src/treasury/Treasury.sol#L124)

	```solidity
	    function withdraw(address token, address to, uint256 amount) external nonReentrant onlyRole(DEFAULT_ADMIN_ROLE) {
	```

- Found in src/treasury/Treasury.sol [Line: 136](src/treasury/Treasury.sol#L136)

	```solidity
	    function pause() external onlyRole(PAUSER_ROLE) {
	```

- Found in src/treasury/Treasury.sol [Line: 141](src/treasury/Treasury.sol#L141)

	```solidity
	    function unpause() external onlyRole(PAUSER_ROLE) {
	```

</details>



## L-2: Large Numeric Literal

Large literal values multiples of 10000 can be replaced with scientific notation.Use `e` notation, for example: `1e18`, instead of its full numeric value.

<details><summary>2 Found Instances</summary>


- Found in src/staking/Staking.sol [Line: 64](src/staking/Staking.sol#L64)

	```solidity
	        if (instantExitPenaltyBps_ > 10_000) revert InvalidBps();
	```

- Found in src/staking/Staking.sol [Line: 180](src/staking/Staking.sol#L180)

	```solidity
	        uint256 penalty = (amount * instantExitPenaltyBps) / 10_000;
	```

</details>



## L-3: Literal Instead of Constant

Define and use `constant` variables instead of using literals. If the same constant literal value is used multiple times, create a constant state variable and reference it throughout the contract.

<details><summary>11 Found Instances</summary>


- Found in src/staking/RewardsDistributor.sol [Line: 78](src/staking/RewardsDistributor.sol#L78)

	```solidity
	        userRewardDebt[user] = (_effectiveBalance(user) * accRewardPerShare) / 1e18;
	```

- Found in src/staking/RewardsDistributor.sol [Line: 88](src/staking/RewardsDistributor.sol#L88)

	```solidity
	        userRewardDebt[user] = (_effectiveBalance(user) * accRewardPerShare) / 1e18;
	```

- Found in src/staking/RewardsDistributor.sol [Line: 98](src/staking/RewardsDistributor.sol#L98)

	```solidity
	        userRewardDebt[user] = (_effectiveBalance(user) * accRewardPerShare) / 1e18;
	```

- Found in src/staking/RewardsDistributor.sol [Line: 109](src/staking/RewardsDistributor.sol#L109)

	```solidity
	        userRewardDebt[user] = (_effectiveBalance(user) * accRewardPerShare) / 1e18;
	```

- Found in src/staking/RewardsDistributor.sol [Line: 135](src/staking/RewardsDistributor.sol#L135)

	```solidity
	        accRewardPerShare += (amount * 1e18) / effective;
	```

- Found in src/staking/RewardsDistributor.sol [Line: 156](src/staking/RewardsDistributor.sol#L156)

	```solidity
	        uint256 accumulated = (eff * accRewardPerShare) / 1e18;
	```

- Found in src/staking/RewardsDistributor.sol [Line: 168](src/staking/RewardsDistributor.sol#L168)

	```solidity
	        accRewardPerShare += (amount * 1e18) / effective;
	```

- Found in src/staking/RewardsDistributor.sol [Line: 179](src/staking/RewardsDistributor.sol#L179)

	```solidity
	            accReward += (pendingRewards * 1e18) / effective;
	```

- Found in src/staking/RewardsDistributor.sol [Line: 182](src/staking/RewardsDistributor.sol#L182)

	```solidity
	        uint256 accumulated = (eff * accReward) / 1e18;
	```

- Found in src/staking/Staking.sol [Line: 64](src/staking/Staking.sol#L64)

	```solidity
	        if (instantExitPenaltyBps_ > 10_000) revert InvalidBps();
	```

- Found in src/staking/Staking.sol [Line: 180](src/staking/Staking.sol#L180)

	```solidity
	        uint256 penalty = (amount * instantExitPenaltyBps) / 10_000;
	```

</details>



## L-4: `nonReentrant` is Not the First Modifier

To protect against reentrancy in other modifiers, the `nonReentrant` modifier should be the first modifier in the list of modifiers.

<details><summary>1 Found Instances</summary>


- Found in src/treasury/Treasury.sol [Line: 95](src/treasury/Treasury.sol#L95)

	```solidity
	    ) external onlyRole(DEFAULT_ADMIN_ROLE) nonReentrant whenNotPaused returns (uint256 k613Out) {
	```

</details>



## L-5: State Change Without Event

There are state variable changes in this function but no event is emitted. Consider emitting an event to enable offchain indexers to track the changes.

<details><summary>1 Found Instances</summary>


- Found in src/token/xK613.sol [Line: 69](src/token/xK613.sol#L69)

	```solidity
	    function setRewardsDistributor(address distributor_) external onlyRole(DEFAULT_ADMIN_ROLE) {
	```

</details>



## L-6: Address State Variable Set Without Checks

Check for `address(0)` when assigning values to address state variables.

<details><summary>1 Found Instances</summary>


- Found in src/token/xK613.sol [Line: 70](src/token/xK613.sol#L70)

	```solidity
	        rewardsDistributor = distributor_;
	```

</details>



## L-7: Unchecked Return

Function returns a value but it is ignored. Consider checking the return value.

<details><summary>20 Found Instances</summary>


- Found in src/staking/RewardsDistributor.sol [Line: 52](src/staking/RewardsDistributor.sol#L52)

	```solidity
	        _grantRole(DEFAULT_ADMIN_ROLE, msg.sender);
	```

- Found in src/staking/RewardsDistributor.sol [Line: 53](src/staking/RewardsDistributor.sol#L53)

	```solidity
	        _grantRole(PAUSER_ROLE, msg.sender);
	```

- Found in src/staking/RewardsDistributor.sol [Line: 63](src/staking/RewardsDistributor.sol#L63)

	```solidity
	            _revokeRole(REWARDS_NOTIFIER_ROLE, staking);
	```

- Found in src/staking/RewardsDistributor.sol [Line: 64](src/staking/RewardsDistributor.sol#L64)

	```solidity
	            _revokeRole(STAKING_ROLE, staking);
	```

- Found in src/staking/RewardsDistributor.sol [Line: 67](src/staking/RewardsDistributor.sol#L67)

	```solidity
	        _grantRole(REWARDS_NOTIFIER_ROLE, staking_);
	```

- Found in src/staking/RewardsDistributor.sol [Line: 68](src/staking/RewardsDistributor.sol#L68)

	```solidity
	        _grantRole(STAKING_ROLE, staking_);
	```

- Found in src/staking/Staking.sol [Line: 65](src/staking/Staking.sol#L65)

	```solidity
	        _grantRole(DEFAULT_ADMIN_ROLE, msg.sender);
	```

- Found in src/staking/Staking.sol [Line: 66](src/staking/Staking.sol#L66)

	```solidity
	        _grantRole(PAUSER_ROLE, msg.sender);
	```

- Found in src/token/K613.sol [Line: 34](src/token/K613.sol#L34)

	```solidity
	        _grantRole(DEFAULT_ADMIN_ROLE, msg.sender);
	```

- Found in src/token/K613.sol [Line: 35](src/token/K613.sol#L35)

	```solidity
	        _grantRole(PAUSER_ROLE, msg.sender);
	```

- Found in src/token/K613.sol [Line: 37](src/token/K613.sol#L37)

	```solidity
	        _grantRole(MINTER_ROLE, initialMinter);
	```

- Found in src/token/K613.sol [Line: 47](src/token/K613.sol#L47)

	```solidity
	        _revokeRole(MINTER_ROLE, minter);
	```

- Found in src/token/K613.sol [Line: 50](src/token/K613.sol#L50)

	```solidity
	        _grantRole(MINTER_ROLE, newMinter);
	```

- Found in src/token/xK613.sol [Line: 48](src/token/xK613.sol#L48)

	```solidity
	        _grantRole(DEFAULT_ADMIN_ROLE, msg.sender);
	```

- Found in src/token/xK613.sol [Line: 49](src/token/xK613.sol#L49)

	```solidity
	        _grantRole(PAUSER_ROLE, msg.sender);
	```

- Found in src/token/xK613.sol [Line: 51](src/token/xK613.sol#L51)

	```solidity
	        _grantRole(MINTER_ROLE, initialMinter);
	```

- Found in src/token/xK613.sol [Line: 61](src/token/xK613.sol#L61)

	```solidity
	        _revokeRole(MINTER_ROLE, minter);
	```

- Found in src/token/xK613.sol [Line: 64](src/token/xK613.sol#L64)

	```solidity
	        _grantRole(MINTER_ROLE, newMinter);
	```

- Found in src/treasury/Treasury.sol [Line: 62](src/treasury/Treasury.sol#L62)

	```solidity
	        _grantRole(DEFAULT_ADMIN_ROLE, msg.sender);
	```

- Found in src/treasury/Treasury.sol [Line: 63](src/treasury/Treasury.sol#L63)

	```solidity
	        _grantRole(PAUSER_ROLE, msg.sender);
	```

</details>



## L-8: Unused Error

Consider using or removing the unused error.

<details><summary>5 Found Instances</summary>


- Found in src/staking/Staking.sol [Line: 25](src/staking/Staking.sol#L25)

	```solidity
	    error InsufficientBalance();
	```

- Found in src/staking/Staking.sol [Line: 27](src/staking/Staking.sol#L27)

	```solidity
	    error ExitNotInitiated();
	```

- Found in src/staking/Staking.sol [Line: 29](src/staking/Staking.sol#L29)

	```solidity
	    error ExitNotInitiatedToCancel();
	```

- Found in src/treasury/Treasury.sol [Line: 24](src/treasury/Treasury.sol#L24)

	```solidity
	    error NoController();
	```

- Found in src/treasury/Treasury.sol [Line: 26](src/treasury/Treasury.sol#L26)

	```solidity
	    error NoAssets();
	```

</details>



